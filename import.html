<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Import Backup Data</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body {
    font-family: system-ui, Arial, sans-serif;
    background: #0f172a;
    color: #fff;
    margin: 0;
    padding: 20px;
}
.container {
    max-width: 420px;
    margin: auto;
    background: #020617;
    padding: 20px;
    border-radius: 14px;
}
h2 {
    text-align: center;
    margin-bottom: 10px;
}
input[type=file] {
    width: 100%;
    margin-top: 15px;
}
button {
    width: 100%;
    margin-top: 20px;
    padding: 12px;
    font-size: 16px;
    background: #22c55e;
    border: none;
    border-radius: 10px;
    color: #000;
}
.status {
    margin-top: 15px;
    font-size: 14px;
}
.success { color: #22c55e; }
.error { color: #ef4444; }
</style>
</head>

<body>
<div class="container">
    <h2>Import Backup File</h2>
    <p>Select your exported JSON file</p>

    <input type="file" id="fileInput" accept=".json">
    <button onclick="importBackup()">Import Data</button>

    <div class="status" id="status"></div>
</div>

<script>
const DB_NAME = "OfflineBillingDB";
const DB_VERSION = 1;

function openDB() {
    return new Promise((resolve, reject) => {
        const req = indexedDB.open(DB_NAME, DB_VERSION);
        req.onerror = () => reject("DB open failed");
        req.onsuccess = () => resolve(req.result);
    });
}

function clearStore(db, storeName) {
    return new Promise((resolve, reject) => {
        const tx = db.transaction(storeName, "readwrite");
        const store = tx.objectStore(storeName);
        store.clear();
        tx.oncomplete = resolve;
        tx.onerror = () => reject("Clear failed: " + storeName);
    });
}

function insertAll(db, storeName, items) {
    return new Promise((resolve, reject) => {
        const tx = db.transaction(storeName, "readwrite");
        const store = tx.objectStore(storeName);
        items.forEach(item => store.put(item));
        tx.oncomplete = resolve;
        tx.onerror = () => reject("Insert failed: " + storeName);
    });
}

async function importBackup() {
    const fileInput = document.getElementById("fileInput");
    const status = document.getElementById("status");
    status.textContent = "";

    if (!fileInput.files.length) {
        status.textContent = "Please select a JSON file";
        status.className = "status error";
        return;
    }

    const file = fileInput.files[0];
    if (!file.name.endsWith(".json")) {
        status.textContent = "Invalid file type";
        status.className = "status error";
        return;
    }

    try {
        const text = await file.text();
        const data = JSON.parse(text);

        const db = await openDB();

        // Clear old data
        await clearStore(db, "products");
        await clearStore(db, "salespersons");
        await clearStore(db, "salesHistory");

        // Insert new data
        if (data.products) {
            await insertAll(db, "products", data.products);
        }
        if (data.salespersons) {
            await insertAll(db, "salespersons", data.salespersons);
        }
        if (data.salesHistory) {
            await insertAll(db, "salesHistory", data.salesHistory);
        }

        // Restore settings
        if (data.settings) {
            Object.keys(data.settings).forEach(key => {
                localStorage.setItem(key, data.settings[key]);
            });
        }

        status.innerHTML = `
            <div class="success">
                Import successful ✔️<br>
                Products: ${data.products?.length || 0}<br>
                Users: ${data.salespersons?.length || 0}<br>
                Sales: ${data.salesHistory?.length || 0}
            </div>
        `;
    } catch (err) {
        status.textContent = "Import failed: invalid backup file";
        status.className = "status error";
    }
}
</script>
</body>
</html>
